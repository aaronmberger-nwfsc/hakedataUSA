---
title: Preliminary information on U.S. fishery
author: Joint Technical Committee (JTC)
output:  beamer_presentation
lang: en
params:
  wednesdaynumber: 3
---

```{r setup, echo = FALSE}
options(scipen = 999)

year <- format(Sys.time(), "%Y")
assessmentyear <- as.numeric(year) - 
  as.numeric(as.numeric(format(Sys.time(), "%m")) < 5)

mydir <- hakedatawd()
mydirfiles <- dir(
  full.names = TRUE,
  file.path(mydir, "extractedData"),
  pattern = "\\.Rdat"
)
for (i in mydirfiles) {
  load(i)
}
```

---
date: `r format(ithweekdate(params$wednesdaynumber), "%b. %d, %Y")`
---

```{r calc-attainment, echo = FALSE}

atseacatch <- aggregate(
  OFFICIAL_TOTAL_CATCH ~ VESSEL_TYPE + format(as.Date(HAUL_DATE),"%Y"),
  data = ncatch[ncatch$SPECIES == 206 & ncatch$VESSEL_TYPE %in% 1:2, ],
  sum
)
atseacatchMS <- atseacatch[atseacatch$VESSEL_TYPE == 2 & atseacatch[, 2] == year, 3]
atseacatchCP <- atseacatch[atseacatch$VESSEL_TYPE == 1 & atseacatch[, 2] == year, 3]

tribalcatchinpacfin <- 3319.9764 - pcatch %>%
  dplyr::filter(FLEET == "TI", YEAR == year) %>%
  dplyr::summarize(MT = sum(MT)) %>%
  dplyr::pull(MT)
shorecatch <- tribalcatchinpacfin + pcatch %>%
  dplyr::filter(
    YEAR == assessmentyear,
    FLEET %in% c("LE", "TI", "OA")
  ) %>%
  dplyr::group_by(YEAR) %>%
  dplyr::summarize(MT = sum(MT)) %>%
  dplyr::pull(MT)
researchcatch <- pcatch %>%
  dplyr::filter(
    YEAR == assessmentyear,
    FLEET %in% c("R")
  ) %>%
  dplyr::group_by(YEAR) %>%
  dplyr::summarize(MT=sum(MT)) %>%
  dplyr::pull(MT)

allcatch <- atseacatchMS + atseacatchCP + shorecatch + researchcatch

tacsraw <- read.csv(
  file.path(mydir, "Catches", "quotas.csv")
)
tacs <- c(tacsraw[, NCOL(tacsraw)])
names(tacs) <- tacsraw[, 1]
```

```{r calc-numread, echo = FALSE}
ntable <- dplyr::group_by(
  atsea.ages,
  Year, read = !is.na(AGE)
) %>%
  dplyr::count() %>%
  dplyr::filter(read, Year %in% 2008:year) %>%
  dplyr::pull(n)
ptable <- table(
  page[!is.na(page[, "AGE_YEARS"]), c("SAMPLE_YEAR")],
  useNA = "ifany")

final <- data.frame(
  "Year" = names(ptable),
  "At-Sea" = ntable,
  "Shoreside" = c(ptable), check.names = FALSE) %>%
  dplyr::filter(Year %in% (as.numeric(year) - 10:0))
final[, "Total"] <- rowSums(final[, -1])
```

# `r year` US Catch (preliminary)
##
\centering
Catch = `r xformat(allcatch)` (mt)

TAC = `r xformat(sum(tacs))` (mt)

Attainment =  `r format(allcatch/sum(tacs)*100, nsmall = 1, digits = 1)` (\%)

## Mothership (MS)
\centering
Catch = `r xformat(atseacatchMS)` (mt)

TAC =  `r xformat(tacs["MS"])` (mt)

Attainment =  `r format(atseacatchMS/tacs["MS"]*100, nsmall = 1, digits = 1)` (\%)

## Catcher/Processor (CP)
\centering
Catch =  `r xformat(atseacatchCP)` (mt)

TAC =  `r xformat(tacs["CP"])` (mt)

Attainment =  `r format(atseacatchCP/tacs["CP"]*100, nsmall = 1, digits = 1)` (\%)

## Shoreside
\centering
Catch = `r xformat(shorecatch)` (mt; includes `r round(tribalcatchinpacfin, 0)` mt tribal not in PacFIN)

TAC = `r xformat(tacs["Shore"])` (mt)

Attainment =  `r format(shorecatch/tacs["Shore"]*100, nsmall = 1, digits = 1)` (\%)

# Mothership (MS) catch

![](c:/stockAssessment/hake-data/Figures/MsCatchMonthYear.png){width=100% height=100% alt="U.S. fishery catch: Mothership"}

# Catcher/Processor (CP) catch

![](c:/stockAssessment/hake-data/Figures/CpCatchMonthYear.png){width=100% height=100% alt="U.S. fishery catch: Catcher/Processor"}

# Shoreside catch

![](c:/stockAssessment/hake-data/Figures/shoresideCatchMonthYear.png){width=100% height=100% alt="U.S. fishery catch: Shoreside"}

# At-sea fishing depths

![](c:/stockAssessment/hake-data/Figures/fishDepthsUS.png){width=100% height=100% alt="U.S. at-sea fishery catch depths (fathoms)"}

# At-Sea catch-rate

![](c:/stockAssessment/hake-data/Figures/fishCatchRatesUSnolog.png){width=100% height=100% alt="U.S. at-sea fishery catch-rate"}

# Raw length

![](c:/stockAssessment/hake-data/Figures/raw_length_AtSea.png){width=100% height=100% alt="U.S. at-sea fishery length distribution"}
![](c:/stockAssessment/hake-data/Figures/raw_length_shore.png){width=100% height=100% alt="U.S. shoreside fishery length distribution"}

# Raw weight

![](c:/stockAssessment/hake-data/Figures/raw_weight_AtSea.png){width=100% height=100% alt="U.S. at-sea fishery weight distribution"}
![](c:/stockAssessment/hake-data/Figures/raw_weight_shore.png){width=100% height=100% alt="U.S. shoreside fishery weight distribution"}

# Recent age structures

```{r tableagestructures, asis = TRUE, echo = FALSE}
knitr::kable(final, row.names = FALSE, label = NULL,
  format = "markdown",
  caption = "Preliminary number of ages for at-sea and shoreside sectors.")
```

# Recent age structures by month

```{r tableagesbymonth, asis = TRUE, echo = FALSE}
a <- data.frame(
  table(as.numeric(
    format(
      subset(
        atsea.ages,
        YEAR == assessmentyear & !is.na(AGE))$HAUL_OFFLOAD_DATE,
      "%m"
    )
  ))
)
b <- data.frame(
  table(subset(
    page,
    SAMPLE_YEAR == assessmentyear & !is.na(AGE_YEARS))$SAMPLE_MONTH
  )
)
knitr::kable(
  merge(a, b, by = "Var1", all = TRUE) %>% arrange(Var1),
  format = "markdown",
  col.names = c("Month", "At-Sea", "Shoreside"),
  row.names = FALSE,
  label = NULL,
  caption = glue::glue('Number of {assessmentyear} ages for at-sea and shoreside sectors by month.')
)
```

# Delays in accessing data

* Lack of electronic fish tickets by some in shoreside fishery
* Delayed access to data from at-sea observers because of protocols related to covid-19
* Lack of access to lab space because of covid-19 protocols
* Timing of official end of fishery (i.e., December 31, 2021) and data deadline (i.e., January 03, 2022)
